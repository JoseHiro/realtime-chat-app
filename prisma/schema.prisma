// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                 String              @id @default(uuid())
  email              String              @unique
  username           String?
  password           String
  chats              Chat[]
  createdAt          DateTime            @default(now())
  isAdmin            Boolean             @default(false)
  usageEvents        UsageEvent[]
  creditTransactions CreditTransaction[]

  // Stripe-related fields
  stripeCustomerId     String?   @unique
  stripeSubscriptionId String?   @unique
  subscriptionStatus   String? // e.g. "trialing", "active", "canceled", "past_due"
  subscriptionPlan     String? // e.g. "free", "trial", "pro", "premium"
  trialUsedChats       Int       @default(0)
  trialEndsAt          DateTime? // null if no trial

  // Credit system fields
  creditsRemaining  Int       @default(0)
  lastCreditResetAt DateTime?
}

model Chat {
  id                 Int                 @id @default(autoincrement())
  user               User                @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId             String
  title              String?
  message            Message[]
  theme              String?
  politeness         String?
  level              String?
  characterName      String? // e.g. "Sakura" (female) or "Ken" (male)
  time               Int? // Duration in minutes (3, 5, 10)
  createdAt          DateTime            @default(now())
  analysis           Analysis?
  usageEvents        UsageEvent[]
  creditTransactions CreditTransaction[]

  // Credit system fields
  voiceProvider String? // "azure", "elevenlabs", or "realtime"
  creditsUsed   Int?
}

model Message {
  id        Int      @id @default(autoincrement())
  chat      Chat     @relation(fields: [chatId], references: [id], onDelete: Cascade)
  chatId    Int
  sender    String
  message   String
  reading   String?
  english   String?
  createdAt DateTime @default(now())
}

model Analysis {
  id        Int      @id @default(autoincrement())
  chat      Chat     @relation(fields: [chatId], references: [id], onDelete: Cascade)
  chatId    Int      @unique
  result    Json
  createdAt DateTime @default(now())
}

enum Provider {
  OPENAI
  AZURE
  ELEVENLABS
}

enum ApiType {
  CHAT
  SUMMARY
  TTS
  STT
  READING_TRANSLATION
}

enum EventStatus {
  SUCCESS
  ERROR
  TIMEOUT
  RATE_LIMITED
}

enum CreditTransactionType {
  ALLOCATION
  USAGE
  TOPUP
  REFUND
  ADJUSTMENT
}

model UsageEvent {
  id           Int         @id @default(autoincrement())
  userId       String
  user         User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  chatId       Int?
  chat         Chat?       @relation(fields: [chatId], references: [id], onDelete: Cascade)
  provider     Provider
  apiType      ApiType
  status       EventStatus @default(SUCCESS)
  model        String?
  voice        String?
  inputTokens  Int?
  outputTokens Int?
  characters   Int?
  audioSeconds Int?
  costUsd      Decimal     @db.Decimal(10, 6)
  requestId    String?
  responseTime Int?
  messageCount Int?
  errorCode    String?
  createdAt    DateTime    @default(now())

  @@index([userId, createdAt])
  @@index([chatId])
  @@index([provider, apiType])
  @@index([createdAt])
  @@index([status])
}

model CreditTransaction {
  id           Int                   @id @default(autoincrement())
  userId       String
  user         User                  @relation(fields: [userId], references: [id], onDelete: Cascade)
  chatId       Int?
  chat         Chat?                 @relation(fields: [chatId], references: [id], onDelete: SetNull)
  type         CreditTransactionType
  amount       Int // Positive for additions, negative for deductions
  balanceAfter Int // Credit balance after this transaction
  description  String?
  createdAt    DateTime              @default(now())

  @@index([userId, createdAt])
  @@index([chatId])
  @@index([type])
  @@index([createdAt])
}


// --------------------------------------
// å­¦ç¿’ã®éšå±¤æ§‹é€ 
// --------------------------------------

model Chapter {
  id          String   @id @default(cuid())
  title       String
  order       Int
  // ğŸ’¡ è¿½åŠ ï¼šç« å…¨ä½“ã®ã‚¿ã‚°ï¼ˆ"Elementary", "Business" ãªã©ï¼‰
  tags        String[]
  lessons     Lesson[]
  createdAt   DateTime @default(now())
}

model Lesson {
  id          String       @id @default(cuid())
  chapterId   String
  chapter     Chapter      @relation(fields: [chapterId], references: [id])
  title       String
  order       Int
  // ğŸ’¡ è¿½åŠ ï¼šãƒ¬ãƒƒã‚¹ãƒ³ã”ã¨ã®ã‚¿ã‚°ï¼ˆ"Polite", "Adjective" ãªã©ï¼‰
  tags        String[]
  tasks       LessonTask[]
}

model LessonTask {
  lessonId    String
  taskId      String
  order       Int
  lesson      Lesson       @relation(fields: [lessonId], references: [id])
  task        Task         @relation(fields: [taskId], references: [id])
  @@id([lessonId, taskId])
}

// --------------------------------------
// ã‚¿ã‚¹ã‚¯ï¼ˆå•é¡Œï¼‰æœ¬ä½“
// --------------------------------------

model Task {
  id             String       @id @default(cuid())
  type           TaskType
  mode           TaskMode

  targetJapanese String?      // ãƒ¡ã‚¤ãƒ³ã®æ­£è§£ï¼ˆä¾‹: "ç§ã¯å­¦ç”Ÿã§ã™"ï¼‰

  // ğŸ’¡ è¿½åŠ ï¼šè¤‡æ•°æ­£è§£ã®è¨±å®¹ãƒªã‚¹ãƒˆ
  // ä¾‹: ["ã‚ãŸã—ã¯ãŒãã›ã„ã§ã™", "ã¼ãã¯ãŒãã›ã„ã§ã™", "ã‚ãŸã—ã¯ãŒãã›ã„ã "]
  // éŸ³å£°èªè­˜ã®çµæœï¼ˆã²ã‚‰ãŒãªï¼‰ãŒã“ã®ãƒªã‚¹ãƒˆã®ã©ã‚Œã‹ã«ä¸€è‡´ã™ã‚Œã°æ­£è§£ã¨ã™ã‚‹
  acceptedAnswers String[]

  english        String?
  audioUrl       String?

  mainVocabularyId String?
  mainVocabulary   Vocabulary? @relation("MainVocab", fields: [mainVocabularyId], references: [id])

  vocabularies   TaskVocabulary[]
  lessons        LessonTask[]
}

enum TaskType {
  SENTENCE
  VOCAB
}

enum TaskMode {
  MIMIC
  TRANSLATE
}

// --------------------------------------
// å˜èªãƒã‚¹ã‚¿ãƒ¼
// --------------------------------------

model Vocabulary {
  id          String   @id @default(cuid())
  kanji       String?
  hiragana    String
  meaning     String
  // ğŸ’¡ è¿½åŠ ï¼šå˜èªãƒ¬ãƒ™ãƒ«ã®ã‚¿ã‚°ï¼ˆ"Noun", "Verb", "JLPT_N5" ãªã©ï¼‰
  tags        String[]
  audioUrl    String?

  tasksAsMain Task[]   @relation("MainVocab")
  tasksIncluded TaskVocabulary[]
}

// --------------------------------------
// ä¸­é–“ãƒ†ãƒ¼ãƒ–ãƒ«
// --------------------------------------

model TaskVocabulary {
  taskId       String
  vocabularyId String
  startIndex   Int
  endIndex     Int

  // ğŸ’¡ è¿½åŠ ï¼šã“ã®æ–‡ç« å†…ã§ã®ç‰¹åˆ¥ãªæ„å‘³ã‚„è£œè¶³ï¼ˆå¿…è¦ã§ã‚ã‚Œã°ï¼‰
  customMeaning String?

  task         Task       @relation(fields: [taskId], references: [id])
  vocabulary   Vocabulary @relation(fields: [vocabularyId], references: [id])
  @@id([taskId, vocabularyId, startIndex])
}
